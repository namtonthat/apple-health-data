name: Refresh Health Data

on:
  schedule:
    # Run daily at midnight Melbourne time (AEDT UTC+11)
    # Midnight Melbourne = 13:00 UTC previous day
    - cron: '0 13 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  refresh-data:
    runs-on: ubuntu-latest
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      HEVY_API_KEY: ${{ secrets.HEVY_API_KEY }}
      STRAVA_CLIENT_ID: ${{ secrets.STRAVA_CLIENT_ID }}
      STRAVA_CLIENT_SECRET: ${{ secrets.STRAVA_CLIENT_SECRET }}
      STRAVA_REFRESH_TOKEN: ${{ secrets.STRAVA_REFRESH_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync

      - name: Load config from pyproject.toml
        id: config
        run: |
          # Extract non-sensitive config from pyproject.toml
          S3_BUCKET=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['tool']['dashboard']['s3_bucket_name'])")
          AWS_REGION=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['tool']['dashboard']['aws_region'])")
          OPL_URL=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['tool']['dashboard'].get('openpowerlifting_url', ''))")

          echo "S3_BUCKET_NAME=$S3_BUCKET" >> $GITHUB_ENV
          echo "AWS_DEFAULT_REGION=$AWS_REGION" >> $GITHUB_ENV
          echo "OPENPOWERLIFTING_URL=$OPL_URL" >> $GITHUB_ENV

          echo "Loaded config:"
          echo "  S3_BUCKET_NAME=$S3_BUCKET"
          echo "  AWS_DEFAULT_REGION=$AWS_REGION"
          echo "  OPENPOWERLIFTING_URL=$OPL_URL"

      - name: Ingest sources
        run: |
          SOURCES=""
          [ -n "$HEVY_API_KEY" ] && SOURCES="$SOURCES hevy"
          [ -n "$STRAVA_CLIENT_ID" ] && SOURCES="$SOURCES strava"
          [ -n "$OPENPOWERLIFTING_URL" ] && SOURCES="$SOURCES openpowerlifting"
          if [ -n "$SOURCES" ]; then
            uv run python run.py ingest $SOURCES
          else
            echo "No ingest sources configured, skipping"
          fi
        continue-on-error: true

      - name: Cleanse
        run: uv run python run.py cleanse

      - name: Transform
        run: uv run python run.py transform

      - name: Export
        run: uv run python run.py export

      - name: Summary
        run: |
          echo "## Data Refresh Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Melbourne Time:** $(TZ='Australia/Melbourne' date '+%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY
          echo "- **S3 Bucket:** $S3_BUCKET_NAME" >> $GITHUB_STEP_SUMMARY

      - name: Update last_updated timestamp
        run: TZ='Australia/Melbourne' date '+%Y-%m-%d' > last_updated.txt

      - name: Commit and push last_updated
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add last_updated.txt
          git diff --staged --quiet || git commit -m "chore: update last_updated timestamp"
          git push
